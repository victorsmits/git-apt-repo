#!/bin/bash

auto_push=0
if [ "$1" = "--push" ]; then
    auto_push=1
    echo "ğŸš€ Mode push automatique activÃ© (--push)"
fi

get_branches() {
    git branch --format='%(refname:short)' | grep -v HEAD
}

echo "ğŸ¯ SÃ©lectionne la base:"
base=$(get_branches | fzf --prompt="Base > " --height=10 --reverse --bind='ctrl-y:accept' || true)
base=${base:-master}
echo "  â†’ Base: $base"

chain=()
prev=$base

while true; do
    echo ""
    echo "â›“ï¸ SÃ©lectionne la branche suivante:"
    echo "   (EntrÃ©e=ajouter, Ctrl+Y=finir et lancer, Ã‰chap=annuler)"
    
    next=$( (echo "âœ… LANCER"; get_branches | while read b; do 
        [[ " $base ${chain[*]} " =~ " $b " ]] || echo "$b"
    done) | fzf --prompt="$prev -> " --height=12 --reverse --bind='ctrl-y:accept' || true)
    
    [ -z "$next" ] && { echo "âŒ AnnulÃ©"; exit 0; }
    [ "$next" = "âœ… LANCER" ] && break
    
    chain+=("$next")
    prev=$next
    echo "  â†’ ChaÃ®ne: $base -> ${chain[*]}"
done

[ ${#chain[@]} -eq 0 ] && { echo "âš ï¸ Aucune branche"; exit 0; }

echo ""
echo "ğŸš€ Merge cascade: $base -> ${chain[*]}"
[ $auto_push -eq 1 ] && echo "   (avec push automatique)"
read -p "Confirmer? [Y/n] " confirm
[[ "$confirm" =~ ^[Nn]$ ]] && { echo "âŒ AnnulÃ©"; exit 0; }

prev=$base
for branch in "${chain[@]}"; do
    echo ""
    echo "ğŸ”€ git checkout $branch && git pull && git merge $prev"
    git checkout "$branch"
    git pull || echo "âš ï¸ Pull failed or no remote"
    
    if ! git merge "$prev" --no-edit; then
        echo ""
        echo "ğŸ’¥ CONFLIT sur $branch !"
        echo ""
        echo "ğŸ‘‰ RÃ©sous les conflits dans tes fichiers"
        echo "ğŸ‘‰ git add . && git commit"
        echo ""
        
        while [ -f "$(git rev-parse --git-dir)/MERGE_HEAD" ]; do
            read -p "â³ Appuie sur EntrÃ©e quand le merge est terminÃ© (ou 'abort'): " status
            if [ "$status" = "abort" ]; then
                git merge --abort
                echo "âŒ Merge annulÃ© sur $branch"
                exit 1
            fi
        done
        
        echo "âœ… Conflit rÃ©solu sur $branch"
    fi
    
    if [ $auto_push -eq 1 ]; then
        echo "ğŸ“¤ git push origin $branch"
        git push origin "$branch" || echo "âš ï¸ Push failed (maybe no remote?)"
    fi
    
    prev=$branch
done

echo ""
echo "âœ… Cascade terminÃ©e!"
